<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Карта данных v3</title>
    <script src="https://api-maps.yandex.ru/v3/?apikey=ef711d81-f625-4b3c-9d56-bfac2d9dd499&lang=ru_RU"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }

        .toolbar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 18px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
    </style>
    <script>
        let map, markers = {}, coordinates = {};
        const client = mqtt.connect('wss://mqtt.cloa.su:8083/mqtt', {
            username: 'ga1maz',
            password: 'almazg1234'
        });

        async function initMap() {
            await ymaps3.ready;
            ymaps3.import.registerCdn('https://cdn.jsdelivr.net/npm', '@yandex/ymaps3-default-ui-theme@0.0');

            const { YMap, YMapDefaultSchemeLayer, YMapDefaultFeaturesLayer, YMapDefaultMarker } = ymaps3;

            map = new YMap(document.getElementById('map'), {
                location: { center: [54.75, 54.75], zoom: 5 }
            });

            map.addChild(new YMapDefaultSchemeLayer());
            map.addChild(new YMapDefaultFeaturesLayer());
        }

        function updateMap() {
            if (!coordinates['gps/coordinates'] || !coordinates['cps/cord2']) return;

            const [lon1, lat1] = coordinates['gps/coordinates'];
            const [lon2, lat2] = coordinates['cps/cord2'];

            // Удаление старых маркеров
            Object.values(markers).forEach(marker => map.removeChild(marker));

            // Добавляем новые маркеры
            markers.point1 = new ymaps3.YMapDefaultMarker({
                coordinates: [lon1, lat1],
                title: 'Точка 1',
                subtitle: `${lat1}, ${lon1}`,
                color: 'red',
                iconName: 'fallback'
            });

            markers.point2 = new ymaps3.YMapDefaultMarker({
                coordinates: [lon2, lat2],
                title: 'Точка 2',
                subtitle: `${lat2}, ${lon2}`,
                color: 'green',
                iconName: 'fallback'
            });

            map.addChild(markers.point1);
            map.addChild(markers.point2);

            // Вычисление расстояния
            const R = 6371;
            function toRad(deg) { return deg * Math.PI / 180; }

            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = (R * c).toFixed(2);

            document.getElementById('distance').innerText = `Расстояние: ${distance} км`;
        }

        client.on('connect', () => {
            console.log('MQTT connected');
            client.subscribe('gps/coordinates');
            client.subscribe('cps/cord2');
        });

        client.on('message', (topic, message) => {
            const [lat, lon] = message.toString().split(',').map(Number);
            if (!isNaN(lat) && !isNaN(lon)) {
                coordinates[topic] = [lon, lat];
                updateMap();
            }
        });

    </script>
</head>
<body onload="initMap()">
    <div class="toolbar" id="distance">Ожидание данных...</div>
    <div id="map"></div>
</body>
</html>
